
---
title: "Size of impulses and corrections"
output: html_document
---

<style>
.main-container {
    max-width: 940px;
    margin-left: 0;
    margin-right: auto;
}
</style>


Version: 1.0

```{r, echo=FALSE, message=FALSE,warning=FALSE}
##This code takes files from the optimoraR optimization and rank them by best results.
library(htmltools)
library(RColorBrewer)
library(dplyr)
library(ggplot2)
library(plotly)
library(Stocks)
library(data.table)
library(hexbin)
library(splitstackshape)
 library(zoo)
library(tidyr)
library(knitr)
library(ggpubr)
library(dygraphs)

TickerI="USDCHF"

PerCorrection= c(0.1, 0.15, 0.2, 0.25, 0.5)
CriticalSwing=3 # percent change used to identify critical extensions


#Plots for corrections
Data=read.csv("D:/Scrips/Trading/ForexPairs2YrsAll.csv")
Data=cbind(ID=1:nrow(Data),Data)

Data=Data %>% filter(TF =="1 min")

#TickersOpt=sort(unique(Data$TickerNam))

#Tickers
#"USDCHF" "EURAUD" "EURCAD" "EURCHF" "EURGBP" "EURJPY" "EURNZD" "EURUSD" "GBPAUD" "GBPCAD" "GBPCHF" "GBPJPY" "GBPNZD" "GBPUSD" "NZDUSD" "USDCAD" "USDCHF" "USDJPY" "XAUUSD"

 

  DataTickerI=Data %>% filter(TickerNam ==TickerI)

  RawData=data.frame()
  Results=data.frame()
  for (CorrectionI in PerCorrection){
  SizeSwins=ZigZag_Frequency.Swings(DataTickerI$c,change=CorrectionI)
  ZigZag=Zig.Zag(DataTickerI$c,CorrectionI)
  Swings=data.frame(Swings=ZigZag_Swings.Points(DataTickerI$c,change=CorrectionI))
  Swings$X=DataTickerI$X
  Swings=na.omit(Swings) 
  Swings=Swings[1:(nrow(Swings)-1),]
  Swings$SizeSwins=SizeSwins
  
  Swings= Swings %>% mutate(CriticalSwings = ifelse(SizeSwins >= CriticalSwing |SizeSwins <= -CriticalSwing , Swings, NA))
            
#Frequency of swing sizes
    Feq2=data.frame(Impulse =lag(SizeSwins),Correction=SizeSwins)
    Feq2=Feq2 %>% filter(Impulse  >=0)
    Feq2$MinCorrection=CorrectionI
    Feq2$TickerNam=TickerI
    Results=rbind(Results,Feq2)
    
  #Swing postion and size 
    DataI=data.frame(X=DataTickerI$X, o=DataTickerI$o,  h=DataTickerI$h,l=DataTickerI$l,c=DataTickerI$c, Date=DataTickerI$Date, ZigZag)
    DataI=merge(DataI, Swings, by="X", all.x=TRUE)
    DataI$X=NULL
    DataI$MinCorrection=CorrectionI
    DataI$TickerNam=TickerI
    RawData=rbind(RawData,DataI)

  }
  
  
#Candlesticks and zigzags
    Melt = dcast(RawData,Date+o+h+l+c~MinCorrection,value.var = "ZigZag")
    Melt=data.frame(Tick=1:nrow(Melt), Melt) 
    Paired=Melt[,c("Tick", "Date")]
    Melt$Date=NULL
    

#Critical zigzag... those exceeding the 3%
  CritZigZags= RawData %>%  filter(!is.na(CriticalSwings))
  CritZigZags$SizeSwins=round(CritZigZags$SizeSwins,1)
  CritZigZags = dcast(CritZigZags,Date~MinCorrection,value.var = "SizeSwins")


  CritZigZags=merge(CritZigZags,Paired, by="Date", all.x=TRUE)

  
#Doplots charts

  nColors=ncol(Melt)-1
  ColorScale <- colorRampPalette(brewer.pal(n = nColors, name = "Paired") ) #c("yellow","orange", "red"))   
  
  Dygraph=dygraphs::dygraph(Melt, width = "1800" ,height=400)%>%   dyLegend(width = "1200") %>% dyCandlestick() %>% dyOptions(colors = ColorScale(nColors))
  
  
  Dygraph=Dygraph %>% dyEvent(CritZigZags$Tick, CritZigZags$Tick, labelLoc = "bottom",color ="pink", strokePattern ="dotted")
  Dygraph=Dygraph %>% dyAxis("x",  drawGrid = FALSE) 
  
  

#Do density plots
StockIData=Results %>% filter(TickerNam ==TickerI)


xLim=max(StockIData$Impulse)
yLim=min(StockIData$Correction)

if(xLim<=CriticalSwing){xLim=c(0,xLim+0.5)} else {xLim=c(0,CriticalSwing+0.5)}
if(yLim<=-CriticalSwing){yLim=c(yLim-0.5,0)} else {yLim=c(-CriticalSwing-0.5,0)}

for (I in 1:length(PerCorrection)){
  GGPLOT=ggplot((StockIData %>% filter(MinCorrection  ==PerCorrection[I])), aes(x = Impulse , y = Correction )) + geom_hex(show.legend=FALSE ) +  xlim(xLim) + ylim(yLim)+labs(x=PerCorrection[I]) +
    theme(axis.title.x = element_text(vjust = 2)) + geom_hline(yintercept=-CriticalSwing, linetype="dashed", color = "red",size=0.5)+ geom_vline(xintercept=CriticalSwing, linetype="dashed", color = "red",size=0.5)
  Name=paste0("Plot_",I)
  assign(Name,ggplotly(GGPLOT))
}





```



These plots show the minimum price correction at given price extensions... this is like the zig-zag indicator in tradingview, ploting the increases and decreases of certain sizes.






# `r TickerI`

```{r, echo=FALSE, message=FALSE,warning=FALSE, fig.align = 'center', fig.width =18, fig.height = 4}


subplot(Plot_1,Plot_2,Plot_3,Plot_4,Plot_5,titleY = FALSE,   titleX = TRUE, margin = 0.015,nrows =1)


```


Below we show the 2-years time series highlighting the critical zigzags: price extensions larger than ``r   CriticalSwing``% without a correction of the desire size.

```{r, echo=FALSE, message=FALSE,warning=FALSE, fig.align = 'center', fig.width =18, fig.height = 4}


Dygraph


```





<details>
  <summary>Timing critical zigzags</summary>
```{r, echo=FALSE, eval=TRUE}
#do tABLE
knitr::kable(CritZigZags)

```
</details> 




[AUDCAD](https://camilo-mora.github.io/OptiMoraR/01_AUDCAD.html) 
[AUDJPY](https://camilo-mora.github.io/OptiMoraR/02_AUDJPY.html)
[AUDNZD](https://camilo-mora.github.io/OptiMoraR/03_AUDNZD.html) 
[AUDUSD](https://camilo-mora.github.io/OptiMoraR/04_AUDUSD.html) 
[CHFJPY](https://camilo-mora.github.io/OptiMoraR/05_CHFJPY.html) 
[EURAUD](https://camilo-mora.github.io/OptiMoraR/06_EURAUD.html) 
[EURCAD](https://camilo-mora.github.io/OptiMoraR/07_EURCAD.html) 
[EURCHF](https://camilo-mora.github.io/OptiMoraR/08_EURCHF.html) 
[EURGBP](https://camilo-mora.github.io/OptiMoraR/09_EURGBP.html) 
[EURJPY](https://camilo-mora.github.io/OptiMoraR/10_EURJPY.html) 
[EURNZD](https://camilo-mora.github.io/OptiMoraR/11_EURNZD.html) 
[EURUSD](https://camilo-mora.github.io/OptiMoraR/12_EURUSD.html) 
[GBPAUD](https://camilo-mora.github.io/OptiMoraR/13_GBPAUD.html) 
[GBPCAD](https://camilo-mora.github.io/OptiMoraR/14_GBPCAD.html) 
[GBPCHF](https://camilo-mora.github.io/OptiMoraR/15_GBPCHF.html) 
[GBPJPY](https://camilo-mora.github.io/OptiMoraR/16_GBPJPY.html) 
[GBPNZD](https://camilo-mora.github.io/OptiMoraR/17_GBPNZD.html) 
[GBPUSD](https://camilo-mora.github.io/OptiMoraR/18_GBPUSD.html) 
[NZDUSD](https://camilo-mora.github.io/OptiMoraR/19_NZDUSD.html) 
[USDCAD](https://camilo-mora.github.io/OptiMoraR/20_USDCAD.html) 
[USDCHF](https://camilo-mora.github.io/OptiMoraR/21_USDCHF.html) 
[USDJPY](https://camilo-mora.github.io/OptiMoraR/22_USDJPY.html) 
[XAUUSD](https://camilo-mora.github.io/OptiMoraR/23_XAUUSD.html) 
[ALL](https://camilo-mora.github.io/OptiMoraR/24_ALL.html) 

    